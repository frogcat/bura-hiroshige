<!DOCTYPE html>
<html>

<head>
  <meta charset="UTF-8">
  <title>leaflet-boilerplate</title>
  <meta name="viewport" content="initial-scale=1.0, maximum-scale=1.0" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.5.1/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.5.1/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet-hash@0.2.1/leaflet-hash.js"></script>
  <script src="https://code.jquery.com/jquery-3.4.1.min.js"></script>
  <style>
    .wikidata {
      white-space: nowrap;
      width: auto;
      height: auto;
      background: orange;
      border: 1px solid black;
    }

    .wikidata.jps {
      background: red;
    }

    #log {
      position: absolute;
      top: 0;
      left: 0;
      width: auto;
      height: auto;
      background: black;
      color: white;
      z-index: 2000;
    }
  </style>
</head>

<body>
  <div id="map" style="position:absolute;top:0;left:0;bottom:0;right:0;"></div>
  <div id="log"></div>
  <script>
    var map = L.map("map", L.extend({
      zoom: 15,
      center: [35.6707, 139.7852],
      maxZoom: 20
    }, L.Hash.parseHash(location.hash)));

    L.control.layers({
      "淡色地図": L.tileLayer("https://cyberjapandata.gsi.go.jp/xyz/pale/{z}/{x}/{y}.png", {
        attribution: "<a href='http://maps.gsi.go.jp/development/ichiran.html'>地理院タイル</a>",
        maxZoom: 20
      }).addTo(map),
      "古地図": L.tileLayer("http://www.finds.jp/ws/tmc/1.0.0/Kanto_Rapid-900913-L/{z}/{x}/{y}.png", {
        attribution: "<a href='https://habs.dc.affrc.go.jp'>歴史的農業環境閲覧システム</a>",
        maxNativeZoom: 17,
        maxZoom: 20
      }),
      "1936年ごろ": L.tileLayer("https://cyberjapandata.gsi.go.jp/xyz/ort_riku10/{z}/{x}/{y}.png", {
        attribution: "<a href='http://maps.gsi.go.jp/development/ichiran.html'>地理院タイル</a>",
        maxNativeZoom: 18,
        maxZoom: 20
      }),
      "1945-1950年ごろ": L.tileLayer("https://cyberjapandata.gsi.go.jp/xyz/ort_USA10/{z}/{x}/{y}.png", {
        attribution: "<a href='http://maps.gsi.go.jp/development/ichiran.html'>地理院タイル</a>",
        maxNativeZoom: 17,
        maxZoom: 20
      }),
      "1961-1969年ごろ": L.tileLayer("https://cyberjapandata.gsi.go.jp/xyz/ort_old10/{z}/{x}/{y}.png", {
        attribution: "<a href='http://maps.gsi.go.jp/development/ichiran.html'>地理院タイル</a>",
        maxNativeZoom: 17,
        maxZoom: 20
      }),
      "1974-1978年ごろ": L.tileLayer("https://cyberjapandata.gsi.go.jp/xyz/gazo1/{z}/{x}/{y}.jpg", {
        attribution: "<a href='http://maps.gsi.go.jp/development/ichiran.html'>地理院タイル</a>",
        maxNativeZoom: 17,
        maxZoom: 20
      }),
      "1979-1983年ごろ": L.tileLayer("https://cyberjapandata.gsi.go.jp/xyz/gazo2/{z}/{x}/{y}.jpg", {
        attribution: "<a href='http://maps.gsi.go.jp/development/ichiran.html'>地理院タイル</a>",
        maxNativeZoom: 17,
        maxZoom: 20
      }),
      "1984-1986年ごろ": L.tileLayer("https://cyberjapandata.gsi.go.jp/xyz/gazo3/{z}/{x}/{y}.jpg", {
        attribution: "<a href='http://maps.gsi.go.jp/development/ichiran.html'>地理院タイル</a>",
        maxNativeZoom: 17,
        maxZoom: 20
      }),
      "1988-1990年ごろ": L.tileLayer("https://cyberjapandata.gsi.go.jp/xyz/gazo4/{z}/{x}/{y}.jpg", {
        attribution: "<a href='http://maps.gsi.go.jp/development/ichiran.html'>地理院タイル</a>",
        maxNativeZoom: 17,
        maxZoom: 20
      }),
      "2004年": L.tileLayer("https://cyberjapandata.gsi.go.jp/xyz/airphoto/{z}/{x}/{y}.png", {
        attribution: "<a href='http://maps.gsi.go.jp/development/ichiran.html'>地理院タイル</a>",
        maxNativeZoom: 18,
        maxZoom: 20
      }),
      "2007年": L.tileLayer("https://cyberjapandata.gsi.go.jp/xyz/ort/{z}/{x}/{y}.jpg", {
        attribution: "<a href='http://maps.gsi.go.jp/development/ichiran.html'>地理院タイル</a>",
        maxNativeZoom: 18,
        maxZoom: 20
      }),
      "MapWarper日本橋": L.tileLayer("https://mapwarper.net/maps/tile/41996/{z}/{x}/{y}.png",{
        attribution:"<a href='http://dl.ndl.go.jp/info:ndljp/pid/2542361'>MapWarper日本橋</a>"
      })
    }).addTo(map);

    map.zoomControl.setPosition("bottomright");

    L.control.scale({
      imperial: false,
      metric: true
    }).addTo(map);

    L.hash(map);

    var group = L.layerGroup().addTo(map);


    map.on("moveend", function() {
      var bounds = map.getBounds();

      var sparql =
        `SELECT ?place ?placeLabel ?location
WHERE {
  SERVICE wikibase:box {
    ?place wdt:P625 ?location.
    bd:serviceParam wikibase:cornerWest "Point(${bounds.getWest()} ${bounds.getNorth()})"^^geo:wktLiteral.
    bd:serviceParam wikibase:cornerEast "Point(${bounds.getEast()} ${bounds.getSouth()})"^^geo:wktLiteral.
  }
  optional {
    ?place wdt:P6698 ?jps
  }
  SERVICE wikibase:label { bd:serviceParam wikibase:language "ja". }
}`;

      group.clearLayers();

      var time = new Date().getTime();
      $("#log").text("loading");

      fetch(
        "https://query.wikidata.org/sparql?query=" + encodeURIComponent(sparql), {
          "headers": {
            "accept": "application/sparql-results+json"
          },
          "method": "GET",
          "mode": "cors"
        }).then(a => a.json()).then(a => {

        var cost = (new Date().getTime()) - time;
        $("#log").text(a.results.bindings.length + " records in " + cost + " msec");

        a.results.bindings.forEach(x => {
          if (x.location.value.match(/^Point\((.+) (.+)\)$/)) {
            var lon = parseFloat(RegExp.$1);
            var lat = parseFloat(RegExp.$2);

            var html = "<span class='wikidata'>" + x.placeLabel.value + "</span>";
            if (a.jps) html = html.replace('wikidata', 'wikidata jps');
            L.marker([lat, lon], {
              icon: L.divIcon({
                html: html
              })
            }).addTo(group);
            L.marker([lat, lon]).bindPopup("<pre>" + JSON.stringify(x, null, 2) + "</pre>").addTo(group);
          }
        });
      });
    });
  </script>
</body>

</html>
